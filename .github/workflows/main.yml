name: CI/CD

on:
  schedule:
    - cron: "*/10 * * * *" # Runs every 10 minutes
  workflow_dispatch:  # Allow manual triggering for debugging

permissions:
  contents: read
  actions: write

jobs:
  pre-stage:
    name: ðŸ§¹ Cancel previous runs
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ›‘ Cancel Previous Runs
      uses: styfle/cancel-workflow-action@0.12.0
      with:
        access_token: ${{ github.token }}
    - name: â¬‡ï¸ Check out
      uses: actions/checkout@v4
    - run: echo "Building"

  stage1:
    name: Set Variables
    needs: pre-stage
    runs-on: ubuntu-latest
    outputs:
      trig_update_weights_job1: ${{ steps.set-vars.outputs.trig_update_weights_job1 }}
      trig_update_weights_job2: ${{ steps.set-vars.outputs.trig_update_weights_job2 }}
      trig_update_weights_job3: ${{ steps.set-vars.outputs.trig_update_weights_job3 }}
      trig_update_weights_job4: ${{ steps.set-vars.outputs.trig_update_weights_job4 }}
    steps:
      - name: Calculate Minutes Offset
        id: minute-offset
        run: |
          START_TIME=$(date -d "$(date +%Y-%m-%dT00:00:00Z)" +%s)
          CURRENT_TIME=$(date +%s)
          ELAPSED_MINUTES=$(( (CURRENT_TIME - START_TIME) / 60 ))
          echo "elapsed_minutes=$ELAPSED_MINUTES" >> $GITHUB_OUTPUT
          echo "Current Elapsed Minutes: $ELAPSED_MINUTES"
      - name: Set Variables
        id: set-vars
        run: |
          ELAPSED_MINUTES=${{ steps.minute-offset.outputs.elapsed_minutes }}
          echo "trig_update_weights_job1=false" >> $GITHUB_OUTPUT
          # Set trig_update_weights for job2
          if (( ELAPSED_MINUTES % 10 <= 5 )); then
            echo "New allocation will be computed for portfolio ed daily"
            echo "trig_update_weights_job2=true" >> $GITHUB_OUTPUT
          else
            echo "trig_update_weights_job2=false" >> $GITHUB_OUTPUT
          fi
          # Set trig_update_weights for job3
          if (( ELAPSED_MINUTES % 20 <= 5  )); then
            echo "New allocation will be computed for portfolio ed weekly"
            echo "trig_update_weights_job3=true" >> $GITHUB_OUTPUT
          else
            echo "trig_update_weights_job3=false" >> $GITHUB_OUTPUT
          fi
          # Set trig_update_weights for job4
          if (( ELAPSED_MINUTES % 30 <= 5  )); then
            echo "New allocation will be computed for portfolio ed monthly"
            echo "trig_update_weights_job4=true" >> $GITHUB_OUTPUT
          else
            echo "trig_update_weights_job4=false" >> $GITHUB_OUTPUT
          fi
      - name: Debug Variables
        run: |
          echo "Elapsed Minutes: ${{ steps.minute-offset.outputs.elapsed_minutes }}"
          echo "Job 1 Trigger: ${{ steps.set-vars.outputs.trig_update_weights_job1 }}"
          echo "Job 2 Trigger: ${{ steps.set-vars.outputs.trig_update_weights_job2 }}"
          echo "Job 3 Trigger: ${{ steps.set-vars.outputs.trig_update_weights_job3 }}"
          echo "Job 4 Trigger: ${{ steps.set-vars.outputs.trig_update_weights_job4 }}"
  portfolio_lan:
    name: Update Portfolio LAN
    needs: stage1
    uses: ./.github/workflows/portfolio_update.yml
    secrets:
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
    with:
      portfolio_id: 1
      trig_meth_exp: false
      trig_update_weights: ${{ needs.stage1.outputs.trig_update_weights_job1 == 'true'}}

  portfolio_ed_daily:
    name: Update Portfolio ED Daily
    needs: stage1
    uses: ./.github/workflows/portfolio_update.yml
    secrets:
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
    with:
      portfolio_id: 2
      trig_meth_exp: true
      trig_update_weights: ${{ needs.stage1.outputs.trig_update_weights_job2 == 'true'}}

  portfolio_ed_weekly:
    name: Update Portfolio ED Weekly
    needs: stage1
    uses: ./.github/workflows/portfolio_update.yml
    secrets:
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
    with:
      portfolio_id: 3
      trig_meth_exp: false
      trig_update_weights: ${{ needs.stage1.outputs.trig_update_weights_job3 == 'true' }}

  portfolio_ed_monthly:
    name: Update Portfolio ED Monthly
    needs: stage1
    uses: ./.github/workflows/portfolio_update.yml
    secrets:
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
    with:
      portfolio_id: 4
      trig_meth_exp: true
      trig_update_weights: ${{ needs.stage1.outputs.trig_update_weights_job4 == 'true' }}